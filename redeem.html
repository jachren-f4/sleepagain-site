<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script defer src="https://umami-gray-one.vercel.app/script.js" data-website-id="7af0c0e1-476d-4db7-a786-cd335185dbb6"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Redeem Your Sleep Again Pass — Sleep Again</title>
  <link rel="canonical" href="https://sleepagain.co/redeem">
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32.png">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,400;0,8..60,600;1,8..60,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css?v=9">
  <style>
    .redeem-page {
      min-height: 60vh;
      display: flex;
      align-items: flex-start;
      padding: 4rem 0 6rem;
    }

    .redeem-card {
      max-width: 540px;
      margin: 0 auto;
      text-align: center;
    }

    .redeem-label {
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      opacity: 0.55;
      margin: 0 0 1.5rem;
    }

    .redeem-heading {
      font-size: 2rem;
      font-weight: 400;
      line-height: 1.25;
      margin: 0 0 1rem;
    }

    .redeem-body {
      font-size: 1.05rem;
      line-height: 1.65;
      opacity: 0.8;
      margin: 0 0 2.5rem;
    }

    /* State visibility */
    .state { display: none; }
    .state.visible { display: block; }

    /* Spinner */
    .spinner {
      width: 36px;
      height: 36px;
      border: 2px solid rgba(3, 29, 52, 0.15);
      border-top-color: #031D34;
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
      margin: 0 auto 2rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* App Store badge */
    .app-store-btn {
      display: inline-block;
      margin-top: 1.25rem;
    }
    .app-store-btn img {
      height: 48px;
      width: auto;
    }

    /* Manual code display */
    .manual-code {
      display: inline-block;
      margin: 1.25rem auto 0;
      padding: 0.6rem 1.2rem;
      background: #fff;
      border: 1px solid #d4d0c8;
      border-radius: 4px;
      font-family: monospace;
      font-size: 1.1rem;
      letter-spacing: 0.06em;
      color: #031D34;
    }

    /* Desktop QR wrapper */
    .desktop-qr {
      margin: 1.5rem auto 0;
      display: inline-block;
    }
    #desktop-qr-canvas {
      border-radius: 4px;
      display: block;
    }
    .desktop-qr-label {
      margin-top: 0.75rem;
      font-size: 0.85rem;
      opacity: 0.55;
    }

    /* Error state */
    .error-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>

  <!-- Nav (matches site nav) -->
  <div class="announcement-bar">
    New book by <strong>Joakim Achrén</strong> · Coming April 9th, 2026
  </div>
  <header>
    <div class="nav-container">
      <a href="index.html" class="logo">Sleep Again</a>
      <button class="nav-toggle" aria-label="Toggle navigation">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <nav>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="chapters.html">Chapters</a></li>
          <li><a href="author.html">Author</a></li>
          <li class="nav-dropdown">
            <a href="#" class="dropdown-toggle">Resources</a>
            <ul class="dropdown-menu">
              <li><a href="blog/index.html">Articles</a></li>
              <li><a href="faq.html">FAQ</a></li>
            </ul>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <section class="redeem-page">
      <div class="container">
        <div class="redeem-card">

          <!-- STATE: loading / attempting deep link -->
          <div id="state-loading" class="state">
            <div class="spinner"></div>
            <p class="redeem-label">Sleep Again Pass</p>
            <h1 class="redeem-heading">Opening the app&hellip;</h1>
            <p class="redeem-body">If the app doesn't open, download it from the App Store first.</p>
            <a class="app-store-btn" id="loading-app-store-link" href="#"
               data-umami-event="redeem-appstore-click" data-umami-event-context="mobile-loading">
              <!-- Download assets/badge-app-store.svg from Apple's App Store Marketing Guidelines -->
              <img src="assets/badge-app-store.svg" alt="Download on the App Store" style="height:44px;width:auto;">
            </a>
          </div>

          <!-- STATE: app not installed (mobile) -->
          <div id="state-install" class="state">
            <p class="redeem-label">Sleep Again Pass</p>
            <h1 class="redeem-heading">Install Sleep Again first</h1>
            <p class="redeem-body">
              Download the app from the App Store, then come back to this page to activate your 3-month pass.
            </p>
            <a class="app-store-btn" id="install-app-store-link" href="#"
               data-umami-event="redeem-appstore-click" data-umami-event-context="mobile-not-installed">
              <img src="assets/badge-app-store.svg" alt="Download on the App Store">
            </a>
            <br>
            <span class="manual-code" id="install-code-display"></span>
            <p style="margin-top:0.75rem;font-size:0.8rem;opacity:0.55;">
              Keep this code — you'll enter it in the app after installing.
            </p>
          </div>

          <!-- STATE: desktop -->
          <div id="state-desktop" class="state">
            <p class="redeem-label">Sleep Again Pass</p>
            <h1 class="redeem-heading">Open this on your iPhone</h1>
            <p class="redeem-body">
              Scan the QR code below with your iPhone camera to install Sleep Again and activate your 3-month pass.
            </p>
            <div class="desktop-qr">
              <div id="desktop-qr-canvas"></div>
              <p class="desktop-qr-label">Scan with iPhone Camera</p>
            </div>
            <br>
            <span class="manual-code" id="desktop-code-display"></span>
            <p style="margin-top:0.75rem;font-size:0.8rem;opacity:0.55;">
              Or enter the code above manually in the app after installing.
            </p>
          </div>

          <!-- STATE: invalid link -->
          <div id="state-invalid" class="state">
            <div class="error-icon">&#x26A0;&#xFE0F;</div>
            <p class="redeem-label">Invalid Link</p>
            <h1 class="redeem-heading">This link isn't valid</h1>
            <p class="redeem-body">
              Check the email you received and make sure you're using the full link, or enter your code manually in the Sleep Again app.
            </p>
            <a href="index.html" class="btn btn-primary" style="margin-top:1rem;">
              Go to sleepagain.co
            </a>
          </div>

        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-main">
          <h3>Sleep Again</h3>
          <p>A book about reclaiming rest without giving up your ambitions.</p>
        </div>
        <div class="footer-links">
          <h4>Navigate</h4>
          <ul>
            <li><a href="about.html">About the Book</a></li>
            <li><a href="chapters.html">Chapters</a></li>
            <li><a href="author.html">Author</a></li>
            <li><a href="blog/index.html">Articles</a></li>
            <li><a href="faq.html">FAQ</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2026 Joakim Achrén. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script src="js/main.js?v=3"></script>
  <script>
  (function () {
    // Update this once the App Store listing is live (by Mar 24)
    var APP_STORE_URL = 'https://apps.apple.com/app/PLACEHOLDER';
    var DEEP_LINK_SCHEME = 'sleeppredict://redeem';
    var DEEP_LINK_TIMEOUT_MS = 1500;

    function showState(id) {
      document.querySelectorAll('.state').forEach(function (el) {
        el.classList.remove('visible');
      });
      var el = document.getElementById(id);
      if (el) el.classList.add('visible');
    }

    // Read code from URL
    var params = new URLSearchParams(window.location.search);
    var code = params.get('code');

    if (!code) {
      showState('state-invalid');
      return;
    }

    // Persist code in localStorage so the app can pick it up post-install
    try {
      localStorage.setItem('sleeppredict_redeem_code', code);
    } catch (e) {
      // localStorage may be blocked in private browsing — non-fatal
    }

    // Detect mobile vs desktop
    var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    if (isMobile) {
      // -----------------------------------------------------------------------
      // Mobile: attempt deep link, fall back to App Store install state
      // -----------------------------------------------------------------------
      showState('state-loading');

      // Set App Store link on the loading state button immediately
      document.getElementById('loading-app-store-link').href = APP_STORE_URL;

      // Set up fallback: if the app isn't installed, the deep link won't fire
      // and the page remains visible. After the timeout, show the install state.
      var fallbackTimer = setTimeout(function () {
        document.getElementById('install-code-display').textContent = code;
        document.getElementById('install-app-store-link').href = APP_STORE_URL;
        showState('state-install');
      }, DEEP_LINK_TIMEOUT_MS);

      // Attempt deep link via hidden iframe (avoids triggering browser error dialogs)
      var iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = DEEP_LINK_SCHEME + '?code=' + encodeURIComponent(code);
      document.body.appendChild(iframe);

      // If the app opens, the page will be backgrounded and visibilitychange fires.
      // Clear the fallback timer so we don't show the install state on return.
      document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
          clearTimeout(fallbackTimer);
        }
      });

    } else {
      // -----------------------------------------------------------------------
      // Desktop: show QR code linking to the redeem URL (mobile opens in app)
      // -----------------------------------------------------------------------
      var redeemUrl = window.location.href; // full URL including ?code=...

      document.getElementById('desktop-code-display').textContent = code;
      showState('state-desktop');

      // Render QR code via qrserver.com (no library dependency)
      var img = document.createElement('img');
      img.src = 'https://api.qrserver.com/v1/create-qr-code/?data=' + encodeURIComponent(redeemUrl) + '&size=200x200&margin=10&color=031D34&bgcolor=F5F3F0';
      img.alt = 'QR code';
      img.width = 200;
      img.height = 200;
      img.style.borderRadius = '4px';
      document.getElementById('desktop-qr-canvas').appendChild(img);
    }
  })();
  </script>
</body>
</html>
